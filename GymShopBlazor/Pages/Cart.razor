@page "/cart"
@using GymShopBlazor.Models
@using GymShopBlazor.Pages

<head>
    <link href="css/cart.css" rel="stylesheet" />
</head>

<div class="shopping-cart">
    <h3>Varukorg</h3>

    @foreach (var item in CartService.CartItems)
    {
        <CartItem Item="item" OnQuantityChanged="UpdateQuantity" OnRemove="RemoveItem" />
    }

    @if (CartService.CartItems.Count > 0)
    {
        <div class="cart-summary">
            <h4>Totalt ordervärde: @totalPrice.ToString("0.00") SEK</h4>
            @if (!isCheckoutOpen)
            {
                <button class="btn btn-success" @onclick="OpenCheckout">Betala</button>
            }
        </div>
    }
    else
    {
        <p>Din varukorg är tom.</p>
    }

    @if (isCheckoutOpen)
    {
        <Checkout/>
    }
</div>

@code {
    private List<OrderProduct> cartItems = new();

    private double totalPrice;
    private bool isCheckoutOpen = false;

    [Inject] private CartService CartService { get; set; } = default!;

    protected override void OnInitialized()
    {
        CartService.OnCartUpdated += StateHasChanged;
        totalPrice = CartService.GetTotalPrice();
    }

    public void Dispose()
    {
        CartService.OnCartUpdated -= StateHasChanged;
    }

    private void UpdateTotalPrice()
    {
        totalPrice = CartService.CartItems.Sum(item => item.CurrentPrice * item.Quantity);
        StateHasChanged();
    }

    private void UpdateQuantity(int newQuantity)
    {
        UpdateTotalPrice();
        StateHasChanged();
    }

    private void RemoveItem(OrderProduct item)
    {
        CartService.RemoveFromCart(item);
    }

    private void OpenCheckout()
    {
        isCheckoutOpen = !isCheckoutOpen;
    }
}
